# CVE-Scanner Configuration Module
#
# Handles CVE-scanner-specific configuration:
# - Landscape credentials
# - Secret access grants
# - Snap resource attachment
#
# This module depends on Stage 1 (principal-charm-cos) being deployed first.
# The terragrunt dependency ensures the app exists before this module runs.
#

# Attach snap resource
resource "terraform_data" "attach_snap_resource" {
  count = var.snap_resource_path != "" && fileexists(var.snap_resource_path) ? 1 : 0

  # Trigger replacement when snap file changes
  input = {
    model     = var.model_name
    app       = var.app_name
    snap_path = var.snap_resource_path
    snap_hash = filesha256(var.snap_resource_path)
  }

  provisioner "local-exec" {
    command = <<-EOT
      set -e
      echo "Attaching snap resource: ${self.input.snap_path}"
      juju attach-resource -m ${self.input.model} ${self.input.app} \
        cve-scanner-snap=${self.input.snap_path}
    EOT
  }
}

# Juju Secrets for Landscape Credentials
resource "juju_secret" "landscape_api_key" {
  count = var.manage_secrets && var.landscape_api_key_value != "" ? 1 : 0

  model_uuid = var.model_uuid
  name       = "landscape-api-key"

  value = {
    key = var.landscape_api_key_value
  }

  info = "Landscape API Key for CVE Scanner"
}

resource "juju_secret" "landscape_api_secret" {
  count = var.manage_secrets && var.landscape_api_secret_value != "" ? 1 : 0

  model_uuid = var.model_uuid
  name       = "landscape-api-secret"

  value = {
    secret = var.landscape_api_secret_value
  }

  info = "Landscape API Secret for CVE Scanner"
}

# Grant Secret Access to CVE-Scanner Application
resource "juju_access_secret" "landscape_api_key_access" {
  count = var.manage_secrets && var.landscape_api_key_value != "" ? 1 : 0

  model_uuid   = var.model_uuid
  secret_id    = juju_secret.landscape_api_key[0].secret_id
  applications = [var.app_name]

  depends_on = [juju_secret.landscape_api_key]
}

resource "juju_access_secret" "landscape_api_secret_access" {
  count = var.manage_secrets && var.landscape_api_secret_value != "" ? 1 : 0

  model_uuid   = var.model_uuid
  secret_id    = juju_secret.landscape_api_secret[0].secret_id
  applications = [var.app_name]

  depends_on = [juju_secret.landscape_api_secret]
}

# Apply non-secret configuration parameters
resource "terraform_data" "base_config" {
  count = var.landscape_api_uri != "" || var.landscape_ca_cert != "" ? 1 : 0

  # Trigger replacement when config values change
  input = {
    model   = var.model_name
    app     = var.app_name
    api_uri = var.landscape_api_uri
    ca_cert = var.landscape_ca_cert
  }

  # Apply configuration via Juju CLI
  provisioner "local-exec" {
    command = <<-EOT
      set -e
      juju config -m ${self.input.model} ${self.input.app} \
        landscape-api-uri='${self.input.api_uri}' \
        landscape-ca-cert='${self.input.ca_cert}'
    EOT
  }

  depends_on = [terraform_data.attach_snap_resource]
}

# Apply secret configuration parameters
resource "terraform_data" "secret_config" {
  count = var.manage_secrets && var.landscape_api_key_value != "" && var.landscape_api_secret_value != "" ? 1 : 0

  # Trigger replacement when secret IDs change
  input = {
    model         = var.model_name
    app           = var.app_name
    api_key_id    = juju_secret.landscape_api_key[0].secret_id
    api_secret_id = juju_secret.landscape_api_secret[0].secret_id
  }

  provisioner "local-exec" {
    command = <<-EOT
      set -e
      juju config -m ${self.input.model} ${self.input.app} \
        landscape-api-key=secret:${self.input.api_key_id} \
        landscape-api-secret=secret:${self.input.api_secret_id}
    EOT
  }

  depends_on = [
    juju_secret.landscape_api_key,
    juju_secret.landscape_api_secret,
    juju_access_secret.landscape_api_key_access,
    juju_access_secret.landscape_api_secret_access,
    terraform_data.attach_snap_resource,
  ]
}
