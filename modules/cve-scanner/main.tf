# CVE Scanner Complete Deployment - Wrapper Module
#
# Composes principal-charm-cos and cve-scanner-config modules for complete
# CVE Scanner deployment on a single Juju controller.
#
# This module provides a simplified interface for deploying:
# - Principal charm (cve-scanner) with grafana-agent
# - Landscape credentials and snap resource attachment
# - COS integration via cross-model offers
#

# Stage 1: Deploy Principal Charm + COS Integration
module "principal" {
  source = "../principal-charm-cos"

  # Model configuration
  model_name   = var.model_name
  cloud_name   = var.cloud_name
  cloud_region = var.cloud_region

  # Charm deployment
  charm_source  = var.charm_source
  charm_path    = var.charm_path
  charm_name    = var.charm_name
  charm_channel = var.charm_channel
  app_name      = var.app_name
  units         = var.units
  base          = var.base
  constraints   = var.constraints

  # COS integration
  enable_cos_integration = var.enable_cos_integration
  grafana_agent_channel  = var.grafana_agent_channel
  prometheus_offer_url   = var.prometheus_offer_url
  loki_offer_url         = var.loki_offer_url
  grafana_offer_url      = var.grafana_offer_url
}

# Stage 2: CVE Scanner Configuration (Snap + Landscape Credentials)
module "cve_config" {
  source = "../cve-scanner-config"

  # Inputs from Stage 1
  model_uuid = module.principal.model_uuid
  model_name = module.principal.model_name
  app_name   = module.principal.app_name

  # CVE Scanner specific
  snap_resource_path         = var.snap_resource_path
  landscape_api_uri          = var.landscape_api_uri
  manage_secrets             = var.manage_secrets
  landscape_api_key_value    = var.landscape_api_key_value
  landscape_api_secret_value = var.landscape_api_secret_value
  landscape_ca_cert          = var.landscape_ca_cert

  # Explicit dependency on Stage 1
  depends_on = [module.principal]
}
