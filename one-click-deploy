#!/usr/bin/env bash
#
# One-Click Deployment Script for Smoke Detector
# Wrapper for sequential Terragrunt execution to avoid controller race conditions
#
# Usage: ./one-click-deploy --env <environment> [options]
#

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}==>${NC} $1"
}

# Usage/help text
usage() {
    echo -e "${GREEN}Smoke Detector One-Click Deployment${NC}"
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo "  $0 --env <environment> [--cve-scanner] [--cos-config] [options]"
    echo ""
    echo -e "${YELLOW}Required Arguments:${NC}"
    echo "  --env <name>              Environment name (e.g., default, env-1)"
    echo "                            Corresponds to ./environments/<name>/ directory"
    echo ""
    echo -e "${YELLOW}Component Selection (at least one required):${NC}"
    echo "  --cve-scanner             Deploy/manage CVE Scanner component"
    echo "                            (Stages: 01-principal-deploy, 02-cve-scanner-specific)"
    echo "  --cos-config              Deploy/manage COS Configuration component"
    echo "                            (Stage: 03-cos-configuration-deploy)"
    echo ""
    echo -e "${YELLOW}Actions:${NC}"
    echo "  --plan                    Preview changes without applying (default: apply)"
    echo "  --destroy                 Destroy infrastructure instead of creating"
    echo ""
    echo -e "${YELLOW}Other Options:${NC}"
    echo "  -h, --help                Show this help message"
    echo "  --no-auto-approve         Prompt for confirmation (removes --auto-approve flag)"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  # Deploy both components to default environment"
    echo "  $0 --env default --cve-scanner --cos-config"
    echo ""
    echo "  # Deploy only CVE Scanner"
    echo "  $0 --env default --cve-scanner"
    echo ""
    echo "  # Plan changes for COS Configuration"
    echo "  $0 --env default --cos-config --plan"
    echo ""
    echo "  # Destroy CVE Scanner infrastructure"
    echo "  $0 --env default --cve-scanner --destroy"
    echo ""
    echo "  # Deploy with manual confirmation"
    echo "  $0 --env default --cve-scanner --no-auto-approve"
    echo ""
    echo -e "${YELLOW}Notes:${NC}"
    echo "  - Components are independent and can be deployed in any combination"
    echo "  - Sequential execution prevents Juju controller race conditions"
    echo "  - Each component automatically switches to correct controller via hooks"
    echo "  - Destroy operations use reverse order (config before principal)"
    echo ""
    echo -e "${YELLOW}Prerequisites:${NC}"
    echo "  - Run ./scripts/bootstrap.sh to check/install required tools"
    echo "  - Configure ./environments/<name>/environment-config.hcl"
    echo "  - Ensure Juju controllers are bootstrapped and accessible"
    echo ""
}

# Initialize variables
ENV=""
DEPLOY_CVE_SCANNER=false
DEPLOY_COS_CONFIG=false
ACTION="apply"
USE_AUTO_APPROVE=true

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --env)
            if [[ -z "${2:-}" ]]; then
                log_error "Missing argument for --env"
                usage
                exit 1
            fi
            ENV="$2"
            shift 2
            ;;
        --cve-scanner)
            DEPLOY_CVE_SCANNER=true
            shift
            ;;
        --cos-config)
            DEPLOY_COS_CONFIG=true
            shift
            ;;
        --plan)
            ACTION="plan"
            shift
            ;;
        --destroy)
            ACTION="destroy"
            shift
            ;;
        --no-auto-approve)
            USE_AUTO_APPROVE=false
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Set auto-approve flag based on action and user preference
# Note: terraform plan doesn't accept --auto-approve flag
if [[ "$USE_AUTO_APPROVE" == true ]] && [[ "$ACTION" != "plan" ]]; then
    AUTO_APPROVE="--auto-approve"
else
    AUTO_APPROVE=""
fi

# Validation
if [[ -z "$ENV" ]]; then
    log_error "Missing required argument: --env"
    usage
    exit 1
fi

if [[ "$DEPLOY_CVE_SCANNER" == false ]] && [[ "$DEPLOY_COS_CONFIG" == false ]]; then
    log_error "At least one component must be specified: --cve-scanner or --cos-config"
    usage
    exit 1
fi

ENV_DIR="$PROJECT_ROOT/environments/$ENV"
if [[ ! -d "$ENV_DIR" ]]; then
    log_error "Environment directory not found: $ENV_DIR"
    log_info "Available environments:"
    find "$PROJECT_ROOT/environments" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sed 's/^/  - /'
    exit 1
fi

# Verify environment config exists
ENV_CONFIG="$ENV_DIR/environment-config.hcl"
if [[ ! -f "$ENV_CONFIG" ]]; then
    log_error "Environment configuration not found: $ENV_CONFIG"
    log_info "Create it from template:"
    log_info "  cd $ENV_DIR"
    log_info "  cp environment-config.template.hcl environment-config.hcl"
    log_info "  vim environment-config.hcl"
    exit 1
fi

# Check required tools
check_requirements() {
    log_info "Checking requirements..."

    local missing_tools=()

    if ! command -v terragrunt &> /dev/null; then
        missing_tools+=("terragrunt")
    fi

    if ! command -v terraform &> /dev/null; then
        missing_tools+=("terraform")
    fi

    if ! command -v juju &> /dev/null; then
        missing_tools+=("juju")
    fi

    if [[ ${#missing_tools[@]} -gt 0 ]]; then
        log_error "Missing required tools: ${missing_tools[*]}"
        log_info "Run: ./scripts/bootstrap.sh"
        exit 1
    fi

    log_info "All required tools found"
}

# Deploy CVE Scanner
deploy_cve_scanner() {
    log_step "Deploying CVE Scanner component..."
    log_info "CVE-Scanner Stage 1: Charm deployment (cve-scanner + grafana-agent + COS integration)"

    if ! terragrunt --working-dir "$ENV_DIR/01-principal-deploy" "$ACTION" $AUTO_APPROVE; then
        log_error "CVE-Scanner Stage 1 failed: Charm deployment"
        return 1
    fi

    log_info "CVE-Scanner Stage 2: CVE Scanner configuration (Landscape integration, snap resource)"
    if ! terragrunt --working-dir "$ENV_DIR/02-cve-scanner-specific" "$ACTION" $AUTO_APPROVE; then
        log_error "Stage 2 failed: CVE Scanner configuration"
        return 1
    fi

    log_info "CVE Scanner deployment completed successfully"
}

# Destroy CVE Scanner (reverse order: Stage 2 then 1)
destroy_cve_scanner() {
    log_step "Destroying CVE Scanner component..."
    log_info "CVE-Scanner Stage 2: Removing CVE Scanner configuration"

    if ! terragrunt --working-dir "$ENV_DIR/02-cve-scanner-specific" destroy $AUTO_APPROVE; then
        log_error "CVE-Scanner Stage 2 failed: CVE Scanner configuration destroy"
        return 1
    fi

    log_info "CVE-Scanner Stage 1: Removing principal charm (cve-scanner + grafana-agent)"
    if ! terragrunt --working-dir "$ENV_DIR/01-principal-deploy" destroy $AUTO_APPROVE; then
        log_error "CVE-Scanner Stage 1 failed: Principal deployment destroy"
        return 1
    fi

    log_info "CVE Scanner destroyed successfully"
}

# Deploy COS Configuration (Stage 3)
deploy_cos_config() {
    log_step "Deploying COS Configuration component..."
    log_info "COS Configuration Stage 3: COS configuration charm deployment and integration"

    if ! terragrunt --working-dir "$ENV_DIR/03-cos-configuration-deploy" "$ACTION" $AUTO_APPROVE; then
        log_error "COS Configuration Stage 3 failed: COS Configuration deployment"
        return 1
    fi

    log_info "COS Configuration deployment completed successfully"
}

# Destroy COS Configuration (Stage 3)
destroy_cos_config() {
    log_step "Destroying COS Configuration component"
    log_info "Stage 3: Removing COS configuration charm"

    if ! terragrunt --working-dir "$ENV_DIR/03-cos-configuration-deploy" destroy $AUTO_APPROVE; then
        log_error "Stage 3 failed: COS Configuration destroy"
        return 1
    fi

    log_info "COS Configuration destroyed successfully"
}

# Main execution
main() {
    log_info "Smoke Detector One-Click Deployment"
    log_info "Environment: $ENV"
    log_info "Action: $ACTION"
    log_info "Components: $(
        components=()
        [[ "$DEPLOY_CVE_SCANNER" == true ]] && components+=("cve-scanner")
        [[ "$DEPLOY_COS_CONFIG" == true ]] && components+=("cos-config")
        echo "${components[*]}"
    )"
    echo ""

    check_requirements
    echo ""

    # Execute based on action and components
    local exit_code=0

    if [[ "$ACTION" == "destroy" ]]; then
        # Destroy in order (components are independent)
        if [[ "$DEPLOY_CVE_SCANNER" == true ]]; then
            if ! destroy_cve_scanner; then
                exit_code=1
            fi
            echo ""
        fi

        if [[ "$DEPLOY_COS_CONFIG" == true ]]; then
            if ! destroy_cos_config; then
                exit_code=1
            fi
            echo ""
        fi
    else
        # Deploy/plan in order (components are independent)
        if [[ "$DEPLOY_CVE_SCANNER" == true ]]; then
            if ! deploy_cve_scanner; then
                exit_code=1
            fi
            echo ""
        fi

        if [[ "$DEPLOY_COS_CONFIG" == true ]]; then
            if ! deploy_cos_config; then
                exit_code=1
            fi
            echo ""
        fi
    fi

    if [[ $exit_code -eq 0 ]]; then
        log_info "All operations completed successfully!"

        if [[ "$ACTION" == "plan" ]]; then
            log_info ""
            log_info "Next steps:"
            log_info "  Review the plan output above"
            log_info "  Run without --plan to apply changes"
        elif [[ "$ACTION" == "apply" ]]; then
            log_info ""
            log_info "Deployment complete! Verify with:"
            if [[ "$DEPLOY_CVE_SCANNER" == true ]]; then
                log_info "  juju status -m <cve-scanner-model>"
            fi
            if [[ "$DEPLOY_COS_CONFIG" == true ]]; then
                log_info "  juju status -m <cos-model>"
            fi
        fi
    else
        log_error "Some operations failed. Check the errors above."
        exit $exit_code
    fi
}

main "$@"
