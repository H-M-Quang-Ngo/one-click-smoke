# Stage 2: CVE-Scanner Specific Configuration
#
# Configures CVE-Scanner charm with Landscape integration
#

terraform {
  source = "../../../modules/cve-scanner-config"

  # Switch to provided controller before Terraform operations
  before_hook "switch_to_controller" {
    commands = ["apply", "destroy", "plan"]
    execute  = ["juju", "switch", local.controller_name]
  }

  # Wait for principal to be active after configuration
  after_hook "wait_for_active" {
    commands     = ["apply"]
    execute      = ["${get_repo_root()}/scripts/wait-for-application.sh", local.model_name, local.app_name, "status==\"active\""]
    run_on_error = true
  }
}

include "root" {
  path = find_in_parent_folders("smoke-root.hcl")
}

dependency "principal" {
  config_path = "../01-principal-deploy"

  mock_outputs = {
    model_uuid = "00000000-0000-0000-0000-000000000000"
    model_name = "mock-model"
    app_name = "mock-app"
  }
}

locals {
  env_vars = read_terragrunt_config(find_in_parent_folders("environment-config.hcl"))

  # Variables for hooks (need direct access, not via dependency)
  controller_name = local.env_vars.locals.controller_name
  model_name = local.env_vars.locals.model_name
  app_name   = local.env_vars.locals.app_name

  # CVE-Scanner specific variables
  snap_resource_path     = local.env_vars.locals.snap_resource_path
  landscape_api_uri      = local.env_vars.locals.landscape_api_uri
  manage_secrets         = local.env_vars.locals.manage_secrets
  landscape_ca_cert_file = local.env_vars.locals.landscape_ca_cert_file

  # Secrets: Read from environment variables with fallback to config file
  # Priority: Environment variable > Config file value
  landscape_api_key_value    = get_env("TF_VAR_landscape_api_key_value", try(local.env_vars.locals.landscape_api_key_value, ""))
  landscape_api_secret_value = get_env("TF_VAR_landscape_api_secret_value", try(local.env_vars.locals.landscape_api_secret_value, ""))
}

inputs = {
  # From Stage 1 dependency
  model_uuid = dependency.principal.outputs.model_uuid
  model_name = dependency.principal.outputs.model_name
  app_name = dependency.principal.outputs.app_name

  # CVE-Scanner specific configuration
  landscape_api_uri = local.landscape_api_uri
  manage_secrets = local.manage_secrets
  landscape_api_key_value = local.landscape_api_key_value
  landscape_api_secret_value = local.landscape_api_secret_value
  landscape_ca_cert = local.landscape_ca_cert_file != "" && fileexists(local.landscape_ca_cert_file) ? file(local.landscape_ca_cert_file) : ""
  snap_resource_path = local.snap_resource_path
}
