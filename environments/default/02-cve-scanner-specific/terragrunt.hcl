# Stage 2: CVE-Scanner Specific Configuration
#
# Configures CVE-Scanner charm with Landscape integration
#

terraform {
  source = "../../../modules/cve-scanner-config"

  # Wait for principal to be active after configuration
  after_hook "wait_for_active" {
    commands     = ["apply"]
    execute      = ["${get_repo_root()}/scripts/wait-for-application.sh", local.model_name, local.app_name, "status==\"active\""]
    run_on_error = true
  }
}

include "root" {
  path = find_in_parent_folders("smoke-root.hcl")
}

dependency "principal" {
  config_path = "../01-principal-deploy"

  mock_outputs = {
    model-uuid = "00000000-0000-0000-0000-000000000000"
    model-name = "mock-model"
    app-name   = "mock-app"
  }
}

locals {
  env_vars = read_terragrunt_config(find_in_parent_folders("environment-config.hcl"))

  # Variables for hooks (need direct access, not via dependency)
  model_name = local.env_vars.locals.model_name
  app_name   = local.env_vars.locals.app_name

  # CVE-Scanner specific variables
  snap_resource_path         = local.env_vars.locals.snap_resource_path
  landscape_api_uri          = local.env_vars.locals.landscape_api_uri
  manage_secrets             = local.env_vars.locals.manage_secrets
  landscape_api_key_value    = local.env_vars.locals.landscape_api_key_value
  landscape_api_secret_value = local.env_vars.locals.landscape_api_secret_value
  landscape_ca_cert_file     = local.env_vars.locals.landscape_ca_cert_file
}

inputs = {
  # From Stage 1 dependency
  model-uuid = dependency.principal.outputs.model-uuid
  model-name = dependency.principal.outputs.model-name
  app-name   = dependency.principal.outputs.app-name

  # CVE-Scanner specific configuration
  landscape-api-uri          = local.landscape_api_uri
  manage-secrets             = local.manage_secrets
  landscape-api-key-value    = local.landscape_api_key_value
  landscape-api-secret-value = local.landscape_api_secret_value
  landscape-ca-cert          = local.landscape_ca_cert_file != "" && fileexists(local.landscape_ca_cert_file) ? file(local.landscape_ca_cert_file) : ""
  snap-resource-path         = local.snap_resource_path
}
